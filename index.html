<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Testlik â€“ Anket Ã‡Ã¶z, Puan Kazan</title>

  <!-- SEO -->
  <meta name="description" content="GiriÅŸ yap, anket Ã§Ã¶z, puan kazan! Testlik; modern, hÄ±zlÄ± ve eÄŸlenceli anket platformudur." />
  <link rel="canonical" href="https://testlik.com/" />
  <meta name="robots" content="index,follow" />

  <!-- Open Graph -->
  <meta property="og:title" content="Testlik â€“ Anket Ã‡Ã¶z, Puan Kazan" />
  <meta property="og:description" content="Kocaman butona tÄ±kla; rastgele anket Ã§Ã¶z ve puan kazan!" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://testlik.com/" />
  <meta property="og:image" content="assets/og-banner.jpg" />

  <!-- JSON-LD -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Testlik",
    "url": "https://testlik.com/",
    "potentialAction": { "@type": "SearchAction", "target": "https://testlik.com/?q={search_term}", "query-input": "required name=search_term" }
  }
  </script>

  <link rel="icon" href="assets/logo.png" />

  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXX" crossorigin="anonymous"></script>

  <!-- Firebase boot (ESM): window.fb = {app, analytics, auth, db} -->
  <script type="module">
    import { initializeApp }   from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
    import { getAnalytics }    from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-analytics.js';
    import { getAuth }         from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
    import { getFirestore }    from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDcneigub2eAJjTrfrkiETuLgy5ule8L6s",
      authDomain: "testlik.firebaseapp.com",
      projectId: "testlik",
      storageBucket: "testlik.firebasestorage.app",
      messagingSenderId: "668524500496",
      appId: "1:668524500496:web:579bb4fc5990c87afedc95",
      measurementId: "G-8ZEYBJCV3T"
    };

    const app = initializeApp(firebaseConfig);
    window.fb = {
      app,
      analytics: getAnalytics(app),
      auth: getAuth(app),
      db: getFirestore(app)
    };
  </script>

  <!-- Stil -->
  <link rel="stylesheet" href="css/style.css" />

  <!-- Ã‡Ã¶zÃ¼len kart rozetleri iÃ§in kÃ¼Ã§Ã¼k ek stil -->
  <style>
    .card.solved { opacity:.72; position:relative; }
    .card .badge-solved{
      position:absolute; top:8px; left:8px;
      background: rgba(124,193,255,.14);
      color:#7cc1ff; border:1px solid rgba(124,193,255,.4);
      font-size:12px; font-weight:800; padding:4px 8px; border-radius:999px;
      backdrop-filter: blur(6px);
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <header class="navbar glass" role="banner">
    <a class="logo" href="index.html" aria-label="Testlik Ana Sayfa">
      <span class="logo-emoji">ğŸ—³ï¸</span> <span class="logo-text">Testlik</span>
    </a>
    <nav class="topnav" aria-label="Ana menÃ¼">
      <a href="index.html" aria-current="page">Anketler</a>
      <a href="puan.html">PuanlarÄ±m</a>
      <a href="oduller.html">Ã–dÃ¼ller</a>
    </nav>
    <button id="authBtn" class="btn ghost" aria-label="GiriÅŸ Yap">GiriÅŸ</button>
  </header>

  <!-- Ãœst Reklam -->
  <div class="ad ad-top" aria-label="Ãœst reklam">
    <ins class="adsbygoogle"
         style="display:block;text-align:center"
         data-ad-client="ca-pub-XXXXXXXXXXXXXXX"
         data-ad-slot="1234567890"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  </div>

  <!-- HERO (animasyonlu dalga + parlayan CTA) -->
  <section class="hero fancy" role="region" aria-label="HÄ±zlÄ± baÅŸla">
    <div class="glow"></div>
    <div class="hero-inner">
      <h1 class="title">Anket Ã‡Ã¶z, <span class="spark">Puan Kazan</span></h1>
      <p class="subtitle">Butona tÄ±kla, rastgele bir ankete Ä±ÅŸÄ±nlan ğŸ¯</p>
      <button id="randomPoll" class="btn cta pulse" aria-label="Rastgele anket Ã§Ã¶z">ğŸ“ Anket Ã‡Ã¶z â€“ Puan Kazan</button>

      <!-- KÃ¼Ã§Ã¼k metrikler (gÃ¶rsel amaÃ§lÄ±) -->
      <div class="metrics">
        <div class="metric"><strong id="m1">+0</strong><span>Aktif Anket</span></div>
        <div class="metric"><strong id="m2">+0</strong><span>GÃ¼nlÃ¼k Oy</span></div>
        <div class="metric"><strong id="m3">+0</strong><span>KazanÄ±lan Puan</span></div>
      </div>
    </div>
    <svg class="wave" viewBox="0 0 1440 120" preserveAspectRatio="none" aria-hidden="true">
      <path d="M0,64L80,69.3C160,75,320,85,480,85.3C640,85,800,75,960,80C1120,85,1280,107,1360,117.3L1440,128L1440,0L1360,0C1280,0,1120,0,960,0C800,0,640,0,480,0C320,0,160,0,80,0L0,0Z"></path>
    </svg>
  </section>

  <!-- Ä°Ã‡ERÄ°K + YAN REKLAMLAR -->
  <main class="wrap" role="main">
    <aside class="ad ad-side left" aria-label="Sol reklam">
      <ins class="adsbygoogle"
           style="display:block;width:160px;height:600px"
           data-ad-client="ca-pub-XXXXXXXXXXXXXXX"
           data-ad-slot="2345678901"></ins>
      <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
    </aside>

    <section class="grid-area" aria-label="PopÃ¼ler anketler">
      <h2 class="section-title">PopÃ¼ler Anketler</h2>
      <div id="pollGrid" class="grid" role="list"></div>
    </section>

    <aside class="ad ad-side right" aria-label="SaÄŸ reklam">
      <ins class="adsbygoogle"
           style="display:block;width:160px;height:600px"
           data-ad-client="ca-pub-XXXXXXXXXXXXXXX"
           data-ad-slot="2345678901"></ins>
      <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
    </aside>
  </main>

  <!-- ALT REKLAM + YASAL LÄ°NKLER -->
  <footer class="footer" role="contentinfo">
    <div class="ad ad-footer" aria-label="Alt reklam">
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-XXXXXXXXXXXXXXX"
           data-ad-slot="3456789012"
           data-ad-format="link"
           data-full-width-responsive="true"></ins>
      <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
    </div>

    <nav class="legal">
      <a href="privacy.html">Gizlilik</a><span>Â·</span>
      <a href="terms.html">KullanÄ±m ÅartlarÄ±</a><span>Â·</span>
      <a href="contact.html">Ä°letiÅŸim</a>
    </nav>
    <small>Â© <span id="yil"></span> Testlik</small>
  </footer>

  <!-- Auth (GiriÅŸ/Ã‡Ä±kÄ±ÅŸ butonu) -->
  <script type="module" src="js/auth.js"></script>

  <!-- Sayfa JS: Ã§Ã¶zÃ¼lenleri filtreleyip rastgele anket, grid'de rozet -->
  <script type="module">
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
    import { collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js';

    const auth = window.fb?.auth;
    const db   = window.fb?.db;

    const yilEl = document.getElementById('yil');
    if (yilEl) yilEl.textContent = new Date().getFullYear();

    // kÃ¼Ã§Ã¼k sayaÃ§ animasyonlarÄ± (gÃ¶rsel)
    const animateTo = (el, to) => {
      if (!el) return;
      let n = 0; const step = Math.ceil(to / 40);
      const t = setInterval(() => { n += step; if (n >= to) { n = to; clearInterval(t); } el.textContent = '+' + n; }, 20);
    };
    animateTo(document.getElementById('m1'), 48);
    animateTo(document.getElementById('m2'), 1260);
    animateTo(document.getElementById('m3'), 8420);

    // yardÄ±mcÄ±lar
    const normalize = (p) => {
      if (!p) return '';
      const s = String(p);
      return s.startsWith('/') ? s : '/' + s;
    };

    async function fetchAllPolls() {
      const res  = await fetch('anketler.json', { cache: 'no-store' });
      const list = res.ok ? await res.json() : [];
      return (Array.isArray(list) ? list : [])
        .filter(x => x && x.link)
        .map(x => ({ ...x, link: normalize(x.link) }));
    }

    async function fetchSolvedSet(uid) {
      const solved = new Set();
      if (!uid || !db) return solved;
      const snap = await getDocs(collection(db, 'users', uid, 'votes'));
      snap.forEach(d => {
        const pid = normalize(d.data()?.pollId || decodeURIComponent(d.id));
        solved.add(pid);
      });
      return solved;
    }

    function buildGrid(all, solved) {
      const grid = document.getElementById('pollGrid');
      if (!grid) return;
      grid.innerHTML = '';

      all.slice(0, 12).forEach((it, i) => {
        const a = document.createElement('a');
        const isSolved = solved?.has?.(it.link);
        a.className = 'card tilt' + (isSolved ? ' solved' : '');
        a.href = it.link;
        a.setAttribute('role', 'listitem');
        a.innerHTML = `
          <div class="thumb"><img src="${it.image || 'assets/og-banner.jpg'}" alt="${it.title || 'Anket'}" loading="lazy" /></div>
          <div class="card-body">
            <h3>${it.title || 'Anket'}</h3>
            <p>${it.desc || ''}</p>
          </div>
          ${isSolved ? '<span class="badge-solved">âœ“ Ã‡Ã¶zÃ¼ldÃ¼</span>' : ''}`;
        grid.appendChild(a);

        if ((i + 1) % 3 === 0) {
          const ad = document.createElement('div');
          ad.className = 'ad infeed';
          ad.innerHTML = `
            <ins class="adsbygoogle" style="display:block"
                 data-ad-client="ca-pub-XXXXXXXXXXXXXXX"
                 data-ad-slot="4567890123"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>`;
          grid.appendChild(ad);
          try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch(e) {}
        }
      });
    }

    async function pickUnsolvedAndGo(uid) {
      const btn = document.getElementById('randomPoll');
      if (btn) btn.disabled = true;

      try {
        const all = await fetchAllPolls();
        let pool = all;

        if (uid) {
          const solved = await fetchSolvedSet(uid);
          const unsolved = all.filter(it => !solved.has(it.link));
          pool = unsolved.length ? unsolved : all;
          if (!unsolved.length) {
            try { alert('TÃ¼m anketleri Ã§Ã¶zmÃ¼ÅŸ gÃ¶rÃ¼nÃ¼yorsun! Yine de rastgele bir anket aÃ§Ä±yoruz.'); } catch {}
          }
        }

        const pick = pool[Math.floor(Math.random() * pool.length)]?.link || '/anketler/anket-1.html';
        location.href = pick;
      } catch (e) {
        console.error('randomPoll hata:', e);
        location.href = '/anketler/anket-1.html';
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    // buton davranÄ±ÅŸÄ±
    document.getElementById('randomPoll')?.addEventListener('click', (e) => {
      e.preventDefault();
      const uid = auth?.currentUser?.uid || null;
      pickUnsolvedAndGo(uid);
    });

    // sayfa yÃ¼klenince grid'i doldur; giriÅŸliyse Ã§Ã¶zÃ¼lenlere rozet koy
    (async () => {
      const all = await fetchAllPolls();
      const uid = auth?.currentUser?.uid || null;
      const solved = uid ? await fetchSolvedSet(uid) : new Set();
      buildGrid(all, solved);

      // giriÅŸ durumu deÄŸiÅŸirse grid'i yeniden boya
      onAuthStateChanged(auth, async (user) => {
        const solved2 = user ? await fetchSolvedSet(user.uid) : new Set();
        buildGrid(all, solved2);
      });
    })();
  </script>
</body>
</html>
